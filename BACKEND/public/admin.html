<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Song Manager</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .song-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    .audio-player { width: 150px; }
  </style>
</head>
<body class="bg-light">

<div class="container mt-4">

  <h2 class="text-center mb-4">Music Admin Panel</h2>

  <!-- ADD UPDATE SONG FORM -->
  <div class="card p-4 mb-4">
    <h4 id="formTitle">Add New Song</h4>

    <form id="songForm" class="mt-3">

      <input type="hidden" id="songId">

      <div class="mb-3">
        <label class="form-label">Song Title</label>
        <input id="title" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Artist</label>
        <input id="artist" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Image File</label>
        <input type="file" id="image" accept="image/*" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Audio File</label>
        <input type="file" id="audio" accept="audio/*" class="form-control">
      </div>

      <button type="submit" class="btn btn-primary" id="submitBtn">Upload Song</button>
      <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>

    </form>
  </div>

  <!-- SONG LIST -->
  <div class="card p-4">
    <h4>All Songs</h4>

    <table class="table table-bordered table-striped mt-3" id="songsTable">
      <thead class="table-dark">
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Artist</th>
          <th>Audio</th>
          <th>Duration</th>
          <th>Options</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
// Load Songs
async function loadSongs() {
  const res = await fetch("/api/songs");
  const songs = await res.json();

  const tbody = document.querySelector("#songsTable tbody");
  tbody.innerHTML = "";

  songs.forEach(song => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td><img src="${song.image}" class="song-img"></td>
      <td>${song.title}</td>
      <td>${song.artist}</td>
      <td><audio controls src="${song.audio}" class="audio-player"></audio></td>
      <td>${song.duration}</td>
      <td>
        <button class="btn btn-sm btn-info mb-1 w-100" onclick="loadIntoForm('${song._id}')">Update</button>
        <button class="btn btn-sm btn-danger w-100" onclick="deleteSong('${song._id}')">Delete</button>
      </td>
    `;

    tbody.appendChild(row);
  });
}

// Load data into form for update
async function loadIntoForm(id) {
  const res = await fetch("/api/songs");
  const songs = await res.json();
  const song = songs.find(s => s._id === id);

  document.getElementById("songId").value = id;
  document.getElementById("title").value = song.title;
  document.getElementById("artist").value = song.artist;

  document.getElementById("formTitle").innerText = "Update Song";
  document.getElementById("submitBtn").innerText = "Save Changes";
}

// Handle Add / Update
document.getElementById("songForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const id = document.getElementById("songId").value;
  const title = document.getElementById("title").value;
  const artist = document.getElementById("artist").value;
  const img = document.getElementById("image").files[0];
  const audio = document.getElementById("audio").files[0];

  const formData = new FormData();
  formData.append("title", title);
  formData.append("artist", artist);
  if (img) formData.append("image", img);
  if (audio) formData.append("audio", audio);

  if (id) {
    // update-full route
    await fetch(`/admin/update-full/${id}`, {
      method: "PUT",
      body: formData
    });
  } else {
    // add new
    await fetch("/admin/upload", {
      method: "POST",
      body: formData
    });
  }

  resetForm();
  loadSongs();
});

// Delete Song
async function deleteSong(id) {
  if (!confirm("Delete this song?")) return;

  await fetch(`/admin/delete/${id}`, { method: "DELETE" });
  loadSongs();
}

// Reset form to add mode
function resetForm() {
  document.getElementById("songId").value = "";
  document.getElementById("title").value = "";
  document.getElementById("artist").value = "";
  document.getElementById("image").value = "";
  document.getElementById("audio").value = "";

  document.getElementById("formTitle").innerText = "Add New Song";
  document.getElementById("submitBtn").innerText = "Upload Song";
}

loadSongs();
</script>

</body>
</html>
